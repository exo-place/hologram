{#- Entity Definitions -#}
{% block definitions %}
  {% if entities | length > 0 %}
    {#- All entities (responding first, then referenced/user) -#}
    {% for entity in entities %}
      {{- "\n\n" if not loop.first -}}
<defs for="{{ entity.name }}" id="{{ entity.id }}">
{{ entity.facts | join("\n") }}
</defs>
      {% if entity.responding and memories[entity.id] and memories[entity.id] | length > 0 %}

<memories for="{{ entity.name }}" id="{{ entity.id }}">
{{ memories[entity.id] | join("\n") }}
</memories>
      {% endif %}
    {% endfor %}

    {#- Multi-Entity Response Format -#}
    {% set responding = entities | selectattr("responding") %}
    {% if responding | length > 1 %}
      {{- "\n" -}}
      {% if freeform -%}
        You are writing as: {{ responding | join(", ", "name") }}. They may interact naturally in your response. Not everyone needs to respond to every message - only include those who would naturally engage. If none would respond, reply with only: none
      {%- else %}
You are: {{ responding | join(", ", "name") }}. Format your response with name prefixes:
{{ responding[0].name }}: Hello there!
{{ responding[1].name }}: Nice to meet you.

Start each character's dialogue on a new line with their name followed by a colon. They may interact naturally.

Not everyone needs to respond to every message. Only respond as those who would naturally engage with what was said. If none would respond, reply with only: none
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock definitions %}

{#- Message history -#}
{% block history %}
  {{- "\n" -}}
  {% for msg in history %}
    {{- "\n" if not loop.first -}}
    {% call send_as("assistant" if responders[msg.entity_id] else "user") -%}
      {{ msg.author }}: {{ msg.content }}
      {%- for embed in msg.embeds %}
      <embed>{{ embed.toJSON() }}</embed>
      {%- endfor %}
      {%- for attachment in msg.attachments %}
      <attachment name="{{ attachment.filename }}"{{ ' type="' + attachment.content_type + '"' if attachment.content_type }} url="{{ attachment.url }}" />
      {%- endfor %}
      {%- for sticker in msg.stickers %}
      [sticker: {{ sticker.name }}]
      {%- endfor %}
      {%- for component in msg.components %}
      <component>{{ component.toJSON() }}</component>
      {%- endfor %}
    {%- endcall %}
  {% endfor %}
{% endblock history %}
